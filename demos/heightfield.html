<!DOCTYPE html>
<html>
  <head>
    <title>cannon.js - Heightfield demo</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css" type="text/css"/>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  </head>
  <body>
    <script src="../build/cannon.js"></script>
    <script src="../build/cannon.demo.js"></script>
    <script src="../libs/dat.gui.js"></script>
    <script src="../libs/Three.js"></script>
    <script src="../libs/TrackballControls.js"></script>
    <script src="../libs/Detector.js"></script>
    <script src="../libs/Stats.js"></script>
    <script src="../libs/smoothie.js"></script>
    <script>

        var demo = new CANNON.Demo();

        demo.addScene("Heightfield", function () {

            // Init world
            var world = demo.getWorld();
            world.gravity.set(0, 0, -10);
            world.broadphase = new CANNON.NaiveBroadphase();

            // Create a matrix of height values
            var matrix = [];
            var sizeX = 15,
                sizeY = 15;
            for (var i = 0; i < sizeX; i++) {
                matrix.push([]);
                for (var j = 0; j < sizeY; j++) {
                    var height = Math.cos(i/sizeX * Math.PI * 2)*Math.cos(j/sizeY * Math.PI * 2) + 2;
                    if(i===0 || i === sizeX-1 || j===0 || j === sizeY-1)
                        height = 3;
                    matrix[i].push(height);
                }
            }

            // Create the heightfield
            var hfShape = new CANNON.Heightfield(matrix, {
                elementSize: 1
            });
            var hfBody = new CANNON.Body({ mass: 0 });
            hfBody.addShape(hfShape);
            hfBody.position.set(-sizeX * hfShape.elementSize / 2, -20, -10);
            world.addBody(hfBody);
            demo.addVisual(hfBody);

            // Add spheres
            var mass = 1;
            for(var i=0; i<sizeX - 1; i++){
                for (var j = 0; j < sizeY - 1; j++) {
                    if(i===0 || i >= sizeX-2 || j===0 || j >= sizeY-2)
                        continue;
                    var sphereShape = new CANNON.Sphere(0.1);
                    var sphereBody = new CANNON.Body({ mass: mass });
                    sphereBody.addShape(sphereShape);
                    sphereBody.position.set(0.25 + i, 0.25 + j, 3);
                    sphereBody.position.vadd(hfBody.position, sphereBody.position);
                    world.addBody(sphereBody);
                    demo.addVisual(sphereBody);
                }
            }
        });

        demo.addScene("hf update", function () {
            // Init world
            var world = demo.getWorld();
            world.gravity.set(0, -10, 0);
            world.broadphase = new CANNON.NaiveBroadphase();

            window['RR'] = function(){
              const from = new CANNON.Vec3(1, 10, 1); 
              const to = new CANNON.Vec3(3, -10, 3);
              var raycastOptions = {
                checkCollisionResponse: false,
                collisionFilterGroup: -1,
                collisionFilterMask: -1,
                skipBackfaces: true,
              };
              var result = new CANNON.RaycastResult();
              world.raycastClosest(from, to, raycastOptions, result);              
              console.log(result.hasHit, result);
            }

            var hd = [0.234375,0.30078125,0.302734375,0.30078125,0.26953125,0.17578125,0.068359375,0,0,0,0.072265625,0.193359375,0.314453125,0.361328125,0.34765625,0.34375,0.32421875,0.259765625,0.123046875,0.01953125,0.0078125,0.0078125,0.005859375,0.00390625,0.001953125,0,0.0078125,0.171875,0.435546875,0.6640625,0.798828125,0.859375,0.87109375,0.3125,0.322265625,0.32421875,0.3203125,0.310546875,0.236328125,0.115234375,0,0,0,0.103515625,0.306640625,0.484375,0.53125,0.537109375,0.5078125,0.44921875,0.35546875,0.1875,0.0546875,0.033203125,0.037109375,0.033203125,0.029296875,0.021484375,0.015625,0.005859375,0.154296875,0.490234375,0.865234375,1.0546875,1.15625,1.1484375,0.333984375,0.345703125,0.345703125,0.33984375,0.328125,0.275390625,0.138671875,0,0,0.02734375,0.1640625,0.43359375,0.662109375,0.76953125,0.80078125,0.791015625,0.705078125,0.5078125,0.322265625,0.169921875,0.142578125,0.12890625,0.11328125,0.10546875,0.078125,0.046875,0.03125,0.09375,0.55078125,1.0703125,1.431640625,1.4921875,1.47265625,0.3671875,0.37890625,0.37890625,0.369140625,0.3515625,0.263671875,0.12109375,0,0,0.076171875,0.25390625,0.537109375,0.744140625,0.896484375,1.056640625,1.10546875,0.998046875,0.751953125,0.509765625,0.353515625,0.3046875,0.263671875,0.248046875,0.228515625,0.21484375,0.169921875,0.130859375,0.181640625,0.716796875,1.365234375,1.75,1.875,1.787109375,0.33984375,0.4140625,0.4140625,0.404296875,0.357421875,0.22265625,0.087890625,0,0,0.1328125,0.33984375,0.56640625,0.798828125,1.05859375,1.251953125,1.357421875,1.265625,1.021484375,0.765625,0.6015625,0.5234375,0.470703125,0.43359375,0.421875,0.39453125,0.357421875,0.345703125,0.49609375,1.111328125,1.853515625,2.212890625,2.24609375,2.03125,0.291015625,0.357421875,0.375,0.337890625,0.248046875,0.1171875,-0.005859375,0.01953125,0.068359375,0.216796875,0.392578125,0.580078125,0.869140625,1.142578125,1.388671875,1.501953125,1.435546875,1.267578125,1.05078125,0.85546875,0.744140625,0.708984375,0.69921875,0.697265625,0.666015625,0.630859375,0.583984375,1.076171875,2.060546875,2.783203125,2.978515625,2.826171875,2.478515625,0.3984375,0.3828125,0.30859375,0.203125,0.115234375,0.037109375,0.0703125,0.146484375,0.205078125,0.357421875,0.490234375,0.681640625,0.974609375,1.283203125,1.486328125,1.568359375,1.50390625,1.34375,1.21484375,1.0390625,0.943359375,0.947265625,0.98046875,0.974609375,0.935546875,0.869140625,1.10546875,1.87109375,2.88671875,3.791015625,4.0078125,3.82421875,3.36328125,0.55859375,0.4609375,0.296875,0.09375,0.060546875,0.09375,0.16015625,0.2734375,0.3671875,0.478515625,0.603515625,0.755859375,1.015625,1.310546875,1.47265625,1.505859375,1.423828125,1.302734375,1.220703125,1.123046875,1.083984375,1.115234375,1.16015625,1.146484375,1.109375,1.271484375,1.669921875,2.568359375,3.568359375,4.291015625,4.845703125,4.880859375,4.140625,0.64453125,0.576171875,0.345703125,0.1328125,0.048828125,0.15234375,0.224609375,0.275390625,0.37109375,0.51953125,0.619140625,0.720703125,0.91015625,1.158203125,1.271484375,1.322265625,1.26171875,1.177734375,1.111328125,1.060546875,1.08984375,1.169921875,1.2109375,1.197265625,1.150390625,1.505859375,2.1328125,2.869140625,4.009765625,5.125,5.71484375,5.84375,5.16796875,0.83984375,0.77734375,0.55078125,0.216796875,-0.01171875,0.021484375,0.103515625,0.19140625,0.326171875,0.505859375,0.55859375,0.5390625,0.6640625,0.806640625,0.978515625,1.01171875,0.98828125,0.9453125,0.8359375,0.8125,0.947265625,1.0703125,1.111328125,1.09765625,1.07421875,1.533203125,2.259765625,2.966796875,4.40234375,5.669921875,6.408203125,6.482421875,5.869140625,1.169921875,1.0625,0.796875,0.400390625,0.078125,-0.150390625,-0.130859375,0.048828125,0.232421875,0.345703125,0.37109375,0.302734375,0.345703125,0.40625,0.61328125,0.689453125,0.69921875,0.6171875,0.490234375,0.4921875,0.68359375,0.8828125,0.93359375,0.908203125,0.888671875,1.357421875,2.017578125,3.158203125,4.505859375,5.775390625,6.14453125,6.14453125,5.5234375,1.396484375,1.162109375,0.88671875,0.572265625,0.13671875,-0.24609375,-0.3359375,-0.1171875,0.064453125,0.08203125,0.01953125,-0.0546875,-0.060546875,0.00390625,0.138671875,0.24609375,0.302734375,0.259765625,0.1484375,0.125,0.373046875,0.5859375,0.71875,0.734375,0.705078125,0.953125,1.54296875,2.703125,4.173828125,5.228515625,5.59765625,5.4453125,4.810546875,1.37109375,1.041015625,0.734375,0.443359375,0.095703125,-0.4140625,-0.60546875,-0.376953125,-0.240234375,-0.318359375,-0.47265625,-0.501953125,-0.490234375,-0.40625,-0.328125,-0.224609375,-0.1015625,-0.08984375,-0.130859375,-0.119140625,0.07421875,0.302734375,0.470703125,0.5078125,0.486328125,0.5234375,0.908203125,1.94921875,3.369140625,4.40234375,4.63671875,4.505859375,3.986328125,1.2421875,0.90234375,0.568359375,0.28515625,-0.0625,-0.64453125,-0.943359375,-0.69140625,-0.63671875,-0.78515625,-0.904296875,-0.865234375,-0.75,-0.763671875,-0.74609375,-0.630859375,-0.41796875,-0.337890625,-0.345703125,-0.30078125,-0.1640625,0.01953125,0.22265625,0.3046875,0.287109375,0.3046875,0.44921875,1.17578125,2.42578125,3.39453125,3.62890625,3.494140625,3.146484375,1.171875,0.78125,0.51171875,0.23046875,-0.337890625,-1.013671875,-1.431640625,-1.12890625,-0.96875,-1.099609375,-1.16796875,-1.078125,-0.9375,-0.96875,-1.001953125,-0.841796875,-0.693359375,-0.54296875,-0.509765625,-0.462890625,-0.32421875,-0.111328125,0.0625,0.154296875,0.173828125,0.193359375,0.26171875,0.525390625,1.5078125,2.2421875,2.740234375,2.802734375,2.474609375,1.154296875,0.82421875,0.490234375,0.130859375,-0.57421875,-1.37109375,-1.697265625,-1.419921875,-1.19921875,-1.21484375,-1.2421875,-1.1875,-1.103515625,-1.08984375,-1.1015625,-0.962890625,-0.78515625,-0.640625,-0.638671875,-0.5859375,-0.404296875,-0.208984375,0.009765625,0.109375,0.12890625,0.15625,0.185546875,0.3203125,0.6171875,1.28515625,1.748046875,1.7578125,1.603515625,1.005859375,0.7109375,0.326171875,-0.1328125,-0.80859375,-1.5859375,-1.755859375,-1.4375,-1.21875,-1.166015625,-1.240234375,-1.236328125,-1.15625,-1.0625,-1.05078125,-0.900390625,-0.767578125,-0.6953125,-0.650390625,-0.61328125,-0.40625,-0.20703125,-0.009765625,0.115234375,0.1328125,0.14453125,0.162109375,0.26171875,0.42578125,0.611328125,0.693359375,0.89453125,0.783203125,0.69140625,0.3515625,0.009765625,-0.337890625,-0.97265625,-1.38671875,-1.546875,-1.236328125,-1.03515625,-0.962890625,-1.03125,-1.087890625,-1.02734375,-0.90625,-0.85546875,-0.771484375,-0.70703125,-0.630859375,-0.58984375,-0.537109375,-0.375,-0.1875,-0.005859375,0.126953125,0.140625,0.140625,0.138671875,0.2265625,0.38671875,0.52734375,0.56640625,0.55078125,0.5,0.560546875,0.296875,0.02734375,-0.181640625,-0.623046875,-1.0625,-1.197265625,-0.876953125,-0.66015625,-0.638671875,-0.716796875,-0.755859375,-0.658203125,-0.59765625,-0.578125,-0.591796875,-0.572265625,-0.5234375,-0.458984375,-0.408203125,-0.310546875,-0.16015625,0.00390625,0.130859375,0.13671875,0.12890625,0.125,0.19921875,0.34375,0.462890625,0.484375,0.474609375,0.43359375,0.794921875,0.62890625,0.392578125,0.203125,-0.20703125,-0.6015625,-0.69140625,-0.4296875,-0.189453125,-0.103515625,-0.158203125,-0.228515625,-0.236328125,-0.1875,-0.32421875,-0.443359375,-0.43359375,-0.337890625,-0.267578125,-0.275390625,-0.234375,-0.111328125,0.03125,0.1171875,0.119140625,0.11328125,0.103515625,0.171875,0.28125,0.3828125,0.421875,0.423828125,0.3984375,0.95703125,0.873046875,0.66015625,0.390625,0.068359375,-0.19921875,-0.2109375,-0.03125,0.19921875,0.31640625,0.296875,0.263671875,0.228515625,0.087890625,-0.095703125,-0.173828125,-0.185546875,-0.14453125,-0.119140625,-0.123046875,-0.125,-0.046875,0.044921875,0.09375,0.083984375,0.076171875,0.06640625,0.123046875,0.2421875,0.33984375,0.37890625,0.388671875,0.3671875,1.005859375,1.021484375,0.794921875,0.5390625,0.263671875,0.16796875,0.23046875,0.37109375,0.4375,0.580078125,0.59375,0.59375,0.5078125,0.27734375,0.125,0.052734375,0.05859375,0.044921875,0.009765625,-0.03515625,-0.041015625,-0.00390625,0.033203125,0.044921875,0.037109375,0.03125,0.02734375,0.099609375,0.228515625,0.33984375,0.3984375,0.412109375,0.37890625,0.94140625,0.998046875,0.8984375,0.703125,0.49609375,0.51953125,0.578125,0.587890625,0.654296875,0.740234375,0.744140625,0.78125,0.6328125,0.42578125,0.30078125,0.283203125,0.265625,0.2109375,0.12890625,0.03515625,0.03125,0.02734375,0.01171875,0.0078125,0.005859375,0,0.001953125,0.095703125,0.248046875,0.421875,0.537109375,0.578125,0.5234375,0.859375,0.9765625,0.921875,0.83203125,0.671875,0.666015625,0.72265625,0.740234375,0.779296875,0.79296875,0.822265625,0.86328125,0.83984375,0.587890625,0.45703125,0.447265625,0.404296875,0.345703125,0.21484375,0.099609375,0.1015625,0.056640625,0.017578125,0,0,0,0.0078125,0.12890625,0.3671875,0.646484375,0.833984375,0.904296875,0.830078125,0.775390625,0.92578125,0.96875,0.861328125,0.677734375,0.591796875,0.61328125,0.671875,0.6953125,0.748046875,0.984375,1.21484375,1.21484375,1.046875,0.908203125,0.728515625,0.669921875,0.53125,0.330078125,0.1953125,0.16796875,0.103515625,0.03515625,0,0,0,0.017578125,0.23046875,0.671875,1.025390625,1.23828125,1.271484375,1.19140625,0.650390625,0.783203125,0.802734375,0.697265625,0.45703125,0.333984375,0.36328125,0.462890625,0.58203125,0.931640625,1.19921875,1.435546875,1.5390625,1.501953125,1.5390625,1.44921875,1.140625,0.91796875,0.58203125,0.392578125,0.314453125,0.20703125,0.08203125,0.017578125,0.0078125,0.0078125,0.046875,0.412109375,0.943359375,1.353515625,1.46875,1.466796875,1.40625,0.62109375,0.728515625,0.76171875,0.611328125,0.328125,0.091796875,0.115234375,0.240234375,0.548828125,0.931640625,1.27734375,1.4453125,1.65625,1.92578125,2.162109375,2.134765625,1.865234375,1.484375,1.044921875,0.595703125,0.462890625,0.322265625,0.169921875,0.076171875,0.05078125,0.0546875,0.1171875,0.564453125,1.134765625,1.501953125,1.548828125,1.5390625,1.458984375,1.142578125,1.216796875,1.08984375,0.833984375,0.52734375,0.240234375,0.095703125,0.076171875,0.435546875,0.876953125,1.25,1.490234375,1.95703125,2.353515625,2.75390625,2.765625,2.55859375,2.333984375,1.916015625,1.4296875,0.884765625,0.53515625,0.349609375,0.236328125,0.20703125,0.1953125,0.228515625,0.681640625,1.279296875,1.638671875,1.666015625,1.630859375,1.5390625,2.171875,2.265625,2.02734375,1.49609375,0.8828125,0.61328125,0.48046875,0.33984375,0.599609375,0.998046875,1.3515625,1.74609375,2.291015625,2.869140625,3.20703125,3.423828125,3.46484375,3.30859375,3.03125,2.423828125,1.7265625,1.15234375,0.615234375,0.48046875,0.3984375,0.39453125,0.44140625,0.80859375,1.353515625,1.71484375,1.7734375,1.69921875,1.580078125,2.98046875,3.08984375,2.826171875,2.2109375,1.423828125,0.96875,0.869140625,0.73046875,0.833984375,1.16015625,1.5234375,1.90625,2.564453125,3.142578125,3.517578125,3.87109375,3.9609375,3.939453125,3.6796875,3.072265625,2.384765625,1.685546875,1.056640625,0.662109375,0.56640625,0.568359375,0.626953125,0.869140625,1.2734375,1.568359375,1.671875,1.623046875,1.458984375,3.111328125,3.251953125,3.33203125,2.7734375,1.93359375,1.1484375,1.083984375,0.953125,0.953125,1.14453125,1.380859375,1.8984375,2.50390625,3.103515625,3.43359375,3.802734375,4.05078125,3.98046875,3.6328125,3.09375,2.51171875,1.998046875,1.333984375,0.72265625,0.6328125,0.630859375,0.703125,0.84375,1.044921875,1.248046875,1.357421875,1.326171875,1.115234375,3.04296875,3.201171875,3.29296875,3.048828125,2.158203125,1.185546875,1.107421875,0.9765625,0.904296875,0.953125,1.091796875,1.45703125,1.982421875,2.453125,2.97265625,3.3828125,3.748046875,3.732421875,3.376953125,2.87109375,2.392578125,2.04296875,1.37890625,0.83203125,0.638671875,0.630859375,0.685546875,0.767578125,0.841796875,0.8828125,0.91796875,0.853515625,0.681640625,2.8671875,3.068359375,3.185546875,2.939453125,2.08203125,1.197265625,1.025390625,0.91015625,0.87109375,0.83984375,0.787109375,0.984375,1.29296875,1.642578125,2.06640625,2.798828125,3.26953125,3.216796875,2.90625,2.4375,2.134765625,1.8125,1.26953125,0.73828125,0.591796875,0.591796875,0.599609375,0.6484375,0.67578125,0.66015625,0.611328125,0.5390625,0.404296875]
            // var hd = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.02734375,0.029296875,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.001953125,0.083984375,0.201171875,0.23046875,0.158203125,0.029296875,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.04296875,0.19921875,0.283203125,0.2890625,0.291015625,0.1328125,0,0,0,0,0,0,0,0,0,0,0.029296875,0.115234375,0.130859375,0.0625,0,0,0,0,0,0,0,0,0,0,0,0,0,0.04296875,0.220703125,0.296875,0.41015625,0.443359375,0.267578125,0.0625,0.02734375,0.01171875,0,0,0,0,0.08984375,0.140625,0.078125,0.228515625,0.40625,0.41796875,0.291015625,0.060546875,0,0,0,0,0,0,0,0,0,0,0,0,0.0078125,0.14453125,0.404296875,0.6015625,0.6015625,0.53125,0.328125,0.22265625,0.177734375,0.162109375,0.248046875,0.41796875,0.46484375,0.587890625,0.474609375,0.271484375,0.439453125,0.53515625,0.529296875,0.466796875,0.158203125,0,0,0,0,0,0,0,0,0,0,0,0,0,0.009765625,0.34765625,0.56640625,0.66796875,0.732421875,0.728515625,0.90234375,0.904296875,0.978515625,1.005859375,1.140625,1.24609375,1.40625,1.169921875,0.779296875,0.783203125,0.744140625,0.595703125,0.51171875,0.16796875,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.236328125,0.54296875,0.845703125,1.033203125,1.216796875,1.130859375,1.1953125,0.935546875,0.91015625,1.013671875,1.078125,1.208984375,1.01171875,0.78125,0.873046875,0.96484375,0.701171875,0.384765625,0.0546875,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.1796875,0.7890625,1.15234375,1.22265625,1.1328125,1.134765625,0.982421875,0.5625,0.380859375,0.353515625,0.52734375,0.720703125,0.71875,0.6171875,0.86328125,0.90625,0.609375,0.1796875,0.0078125,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.234375,0.8125,1.1171875,1.23828125,0.94140625,0.720703125,0.44140625,0.259765625,0.189453125,0.314453125,0.48828125,0.62890625,0.673828125,0.6640625,0.7578125,0.830078125,0.69140625,0.15234375,0.017578125,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.306640625,0.8671875,1.060546875,1.087890625,0.880859375,0.458984375,0.275390625,0.216796875,0.27734375,0.4453125,0.572265625,0.650390625,0.712890625,0.693359375,0.65625,0.775390625,0.6875,0.25,0.033203125,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0234375,0.40234375,0.791015625,0.99609375,1.16796875,0.685546875,0.3125,0.259765625,0.26953125,0.337890625,0.427734375,0.59765625,0.662109375,0.626953125,0.556640625,0.5625,0.7109375,0.611328125,0.40625,0.06640625,0,0,0,0,0,0,0,0,0,0,0,0,0,0.021484375,0.39453125,0.71875,0.943359375,0.970703125,0.646484375,0.333984375,0.37890625,0.30859375,0.28515625,0.40625,0.533203125,0.560546875,0.41796875,0.384765625,0.546875,0.796875,0.689453125,0.35546875,0.0234375,0,0,0,0,0,0,0,0,0,0,0,0,0,0.013671875,0.283203125,0.640625,0.802734375,0.822265625,0.634765625,0.47265625,0.498046875,0.509765625,0.25390625,0.36328125,0.46875,0.427734375,0.265625,0.267578125,0.59375,0.78125,0.716796875,0.28125,0.01953125,0,0,0,0,0,0,0,0,0,0,0,0,0,0.00390625,0.326171875,0.79296875,0.796875,0.966796875,0.62109375,0.533203125,0.56640625,0.453125,0.2578125,0.248046875,0.453125,0.28515625,0.37890625,0.373046875,0.80078125,0.9765625,0.69140625,0.341796875,0.009765625,0,0,0,0,0,0,0,0,0,0,0,0,0,0.041015625,0.4921875,0.798828125,0.958984375,1.078125,0.91796875,0.998046875,0.794921875,0.435546875,0.09375,0.375,0.46484375,0.576171875,0.50390625,0.671875,0.955078125,0.853515625,0.59375,0.248046875,0.017578125,0,0,0,0,0,0,0,0,0,0,0,0,0,0.107421875,0.466796875,0.701171875,0.8984375,1.15625,1.296875,1.125,0.904296875,0.5390625,0.626953125,0.767578125,0.931640625,1.0703125,0.99609375,0.98828125,0.953125,0.755859375,0.54296875,0.302734375,0.076171875,0.009765625,0,0,0,0,0,0,0,0,0,0,0,0,0.083984375,0.345703125,0.638671875,0.9375,1.146484375,1.029296875,1.1640625,1.056640625,1.060546875,1.205078125,1.392578125,1.52734375,1.396484375,1.37109375,1.078125,0.91796875,0.89453125,0.720703125,0.46875,0.20703125,0.02734375,0,0,0,0,0,0,0,0,0,0,0,0,0,0.244140625,0.650390625,0.869140625,0.92578125,0.810546875,0.78125,0.775390625,1.00390625,1.220703125,1.244140625,1.357421875,1.435546875,1.212890625,0.888671875,0.8359375,0.845703125,0.673828125,0.490234375,0.291015625,0.021484375,0,0,0,0,0,0,0,0,0,0,0,0,0,0.173828125,0.43359375,0.599609375,0.765625,0.865234375,0.681640625,0.625,0.69921875,0.79296875,0.8046875,0.966796875,0.859375,0.59375,0.6484375,0.697265625,0.673828125,0.57421875,0.423828125,0.228515625,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.13671875,0.36328125,0.501953125,0.65234375,0.66796875,0.4921875,0.4609375,0.5546875,0.611328125,0.5859375,0.6484375,0.55859375,0.435546875,0.40234375,0.3828125,0.3828125,0.34765625,0.251953125,0.083984375,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.03515625,0.19921875,0.287109375,0.326171875,0.265625,0.248046875,0.275390625,0.3046875,0.30859375,0.310546875,0.271484375,0.203125,0.171875,0.1015625,0.017578125,0.04296875,0.072265625,0.048828125,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.03515625,0.048828125,0.037109375,0.013671875,0.029296875,0.046875,0.033203125,0.056640625,0.04296875,0.01171875,0.015625,0.017578125,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
            // Create a matrix of height values
            var matrix = [];
            var sizeX = 33,
                sizeY = 33;
            for(var i = 0; i < 33; i++){
                if(!matrix[i])matrix[i] = [];
                for(var j = 0; j < 33; j++){
                    matrix[i].push(hd[i*33+j]);
                }
            }
            // var sizeX = 15,
            //     sizeY = 15;
            // for (var i = 0; i < sizeX; i++) {
            //     matrix.push([]);
            //     for (var j = 0; j < sizeY; j++) {
            //         var height = Math.cos(i/sizeX * Math.PI * 2)*Math.cos(j/sizeY * Math.PI * 2) + 2;
            //         if(i===0 || i === sizeX-1 || j===0 || j === sizeY-1)
            //             height = 3;
            //         matrix[i].push(height);
            //     }
            // }

            // Create the heightfield
            var hfShape = new CANNON.Heightfield(matrix, {
                elementSize: 1
            });

            window['DDD'] = function(){
                sizeX = 33;
                sizeY = 33;
                matrix = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]
                updateHeightField(hfShape, matrix, 1);
                demo.addVisual(hfBody);
            }

            const offset = new CANNON.Vec3();
            const quat = new CANNON.Quaternion();
            quat.setFromEuler(-Math.PI/2,0,0);
            offset.set(0,0,sizeX-1)
            var hfBody = new CANNON.Body({ mass: 0 });
            hfBody.addShape(hfShape, offset, quat);
            world.addBody(hfBody);
            demo.addVisual(hfBody);

            // Add spheres
            var mass = 1;
            for(var i=0; i<sizeX - 1; i+=3){
                for (var j = 0; j < sizeY - 1; j+=3) {
                    if(i===0 || i >= sizeX-2 || j===0 || j >= sizeY-2)
                        continue;
                    var sphereShape = new CANNON.Sphere(0.5);
                    var sphereBody = new CANNON.Body({ mass: mass });
                    sphereBody.addShape(sphereShape);
                    sphereBody.linearDamping = 0.1;
                    sphereBody.angularDamping = 0.1;
                    sphereBody.position.set(0.218 + i, 20, 0.235 + j);
                    sphereBody.position.vadd(hfBody.position, sphereBody.position);
                    world.addBody(sphereBody);
                    demo.addVisual(sphereBody);
                }
            }
        });

        demo.addScene("Heightfield Y", function () {
            // Init world
            var world = demo.getWorld();
            world.gravity.set(0, -10, 0);
            world.broadphase = new CANNON.NaiveBroadphase();

            // Create a matrix of height values
            var matrix = [];
            var sizeX = 15,
                sizeY = 15;
            for (var i = 0; i < sizeX; i++) {
                matrix.push([]);
                for (var j = 0; j < sizeY; j++) {
                    var height = Math.cos(i/sizeX * Math.PI * 2)*Math.cos(j/sizeY * Math.PI * 2) + 2;
                    if(i===0 || i === sizeX-1 || j===0 || j === sizeY-1)
                        height = 3;
                    matrix[i].push(height);
                }
            }

            sizeX = 33;
            sizeY = 33;
           matrix = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]
            // Create the heightfield
            var hfShape = new CANNON.Heightfield(matrix, {
                elementSize: 1
            });

            const offset = new CANNON.Vec3();
            const quat = new CANNON.Quaternion();
            quat.setFromEuler(-Math.PI/2,0,0);
            offset.set(0,0,sizeX-1)
            var hfBody = new CANNON.Body({ mass: 0 });
            hfBody.addShape(hfShape, offset, quat);
            // hfBody.position.set(-sizeX * hfShape.elementSize / 2, -20, -10);
            // hfBody.quaternion.setFromEuler(-90,0,0);
            world.addBody(hfBody);
            demo.addVisual(hfBody);

            // Add spheres
            var mass = 10;
            for(var i=0; i<sizeX - 1; i+=3){
                for (var j = 0; j < sizeY - 1; j+=3) {
                    if(i===0 || i >= sizeX-2 || j===0 || j >= sizeY-2)
                        continue;
                    var sphereShape = new CANNON.Sphere(0.5);
                    var sphereBody = new CANNON.Body({ mass: mass });
                    sphereBody.addShape(sphereShape);
                    sphereBody.linearDamping = 0.1;
                    sphereBody.angularDamping = 0.1;
                    sphereBody.position.set(0.218 + i, 20, 0.235 + j);
                    sphereBody.position.vadd(hfBody.position, sphereBody.position);
                    world.addBody(sphereBody);
                    demo.addVisual(sphereBody);
                }
            }
        });

        demo.start(1);

        function updateHeightField (heightField, data, elementSize) {
            heightField.data = data;
            heightField.elementSize = elementSize;
            heightField.updateMinValue();
            heightField.updateMaxValue();
            heightField.updateBoundingSphereRadius();
            heightField.update();
        }

    </script>
  </body>
</html>
